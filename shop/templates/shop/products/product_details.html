{% extends 'shop/layouts/main.html' %}
{% load static %}
{% block title %}
{{ products }} | ShopKart
{% endblock title %}

{% block content %}
<style>
/* ========== PRODUCT DETAILS STYLES ========== */
.product-section {
  background: linear-gradient(135deg, #000000 0%, #434343 100%);
  min-height: 100vh;
  padding: 30px 0;
}

/* Breadcrumb */
.breadcrumb {
  margin: 0 0 20px 0;
  background: transparent;
  padding: 0;
}

.breadcrumb-item a {
  color: #b0b0b0;
  text-decoration: none;
  font-size: 13px;
}

.breadcrumb-item a:hover {
  color: #ffcc00;
}

.breadcrumb-item.active {
  color: #ffcc00;
  font-size: 13px;
}

.breadcrumb-item + .breadcrumb-item::before {
  color: #666;
}

/* Section Header */
.section-header h4 {
  color: #fff;
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 10px;
}

.section-header h4 i {
  color: #ffcc00;
}

.section-header hr {
  border-color: rgba(255, 255, 255, 0.1);
  margin-bottom: 15px;
}

/* Product Card */
.product-detail-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 20px;
}

/* Product Image - ORIGINAL SIZE */
.product-image-box {
  position: relative;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 10px;
  overflow: hidden;
}

.product-image-box img {
  width: 100%;
  height: auto;
  max-height: 350px;
  object-fit: contain;
}

/* Hot Badge */
.hot-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
  color: #fff;
  padding: 4px 12px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
}

/* Product Info */
.product-info {
  padding-left: 25px;
}

.product-title {
  color: #fff;
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
}

.product-vendor {
  color: #ffcc00;
  font-size: 13px;
  margin-bottom: 12px;
}

.product-description {
  color: #b0b0b0;
  font-size: 13px;
  line-height: 1.6;
  margin-bottom: 18px;
}

/* Pricing */
.original-price {
  color: #888;
  font-size: 14px;
  margin-bottom: 5px;
}

.original-price s {
  color: #ff6b6b;
}

.selling-price {
  color: #ffcc00;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 18px;
}

/* Quantity Selector */
.quantity-selector {
  display: inline-flex;
  align-items: center;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 18px;
}

.qty-btn {
  width: 38px;
  height: 38px;
  background: linear-gradient(135deg, #ffcc00 0%, #ff9500 100%);
  border: none;
  color: #000;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.qty-btn:hover {
  background: linear-gradient(135deg, #ff9500 0%, #ffcc00 100%);
}

.qty-input {
  width: 50px;
  height: 38px;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 14px;
  text-align: center;
}

.qty-input:focus {
  outline: none;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn-add-cart {
  padding: 12px 25px;
  background: linear-gradient(135deg, #ffcc00 0%, #ff9500 100%);
  border: none;
  border-radius: 8px;
  color: #000;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-add-cart:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(255, 204, 0, 0.3);
}

.btn-add-cart:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.btn-out-of-stock {
  padding: 12px 25px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: #888;
  font-size: 14px;
  cursor: not-allowed;
}

/* Favorite Button */
.btn-favorite {
  width: 45px;
  height: 45px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #888;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-favorite:hover {
  border-color: #ff6b6b;
  color: #ff6b6b;
}

.btn-favorite.active {
  background: #ff6b6b;
  border-color: #ff6b6b;
  color: #fff;
}

.btn-favorite:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Alert Styling */
.alert-container .alert {
  padding: 10px 15px !important;
  border-radius: 8px !important;
  font-size: 13px !important;
  margin-bottom: 15px !important;
}

.alert-container .alert-success {
  background-color: #d4edda !important;
  border: 1px solid #28a745 !important;
  color: #155724 !important;
}

.alert-container .alert-danger {
  background-color: #f8d7da !important;
  border: 1px solid #dc3545 !important;
  color: #721c24 !important;
}

/* Snackbar */
#authSnackbar {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
  color: #fff;
  padding: 14px 20px;
  border-radius: 10px;
  border: 1px solid rgba(255, 204, 0, 0.2);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9999;
  font-size: 13px;
  opacity: 0;
  transition: all 0.3s ease;
}

#authSnackbar.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

#authSnackbar i {
  color: #ffcc00;
}

.snackbar-btn {
  background: linear-gradient(135deg, #ffcc00 0%, #ff9500 100%);
  color: #000 !important;
  padding: 6px 14px;
  border-radius: 5px;
  text-decoration: none;
  font-weight: 600;
  font-size: 12px;
  margin-left: 10px;
}

/* Responsive */
@media (max-width: 767px) {
  .product-info {
    padding-left: 0;
    padding-top: 20px;
  }

  .product-title {
    font-size: 18px;
  }

  .selling-price {
    font-size: 20px;
  }

  .action-buttons {
    flex-wrap: wrap;
  }

  .btn-add-cart {
    flex: 1;
  }
}
</style>

<section class="product-section">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header">
      <h4><i class="fas fa-box me-2"></i>{{ products }} Details</h4>
      <hr>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'collectionsview' products.category.name %}">{{ products.category.name }}</a></li>
        <li class="breadcrumb-item active">{{ products }}</li>
      </ol>
    </nav>

    <!-- Alert Messages -->
    <div class="alert-container">
      {% include 'shop/inc/message.html' %}
    </div>

    <!-- Product Card -->
    <div class="product-detail-card">
      <div class="row align-items-center">
        <!-- Product Image -->
        <div class="col-md-4">
          <div class="product-image-box">
            {% if products.trending %}
              <span class="hot-badge">Hot</span>
            {% endif %}
            <img src="{{ products.product_image.url }}" alt="{{ products }}">
          </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-8">
          <div class="product-info">
            <h1 class="product-title">{{ products|upper }}</h1>
            <p class="product-vendor">{{ products.vendor }}</p>
            <p class="product-description">{{ products.description }}</p>

            <p class="original-price">MRP: <s>₹{{ products.original_price }}</s></p>
            <p class="selling-price">₹{{ products.selling_price }}</p>

            <input type="hidden" value="{{ products.id }}" id="pid">

            {% if products.quantity > 0 %}
              <div class="quantity-selector">
                <button class="qty-btn" id="btnMinus"><i class="fa fa-minus"></i></button>
                <input type="text" id="txtQty" value="1" class="qty-input">
                <button class="qty-btn" id="btnPlus"><i class="fa fa-plus"></i></button>
              </div>

              <div class="action-buttons">
                <button class="btn-add-cart" id="btnCart">
                  <i class="fa fa-shopping-cart"></i> Add to Cart
                </button>
                <button class="btn-favorite" id="btnFav">
                  <i class="fa fa-heart"></i>
                </button>
              </div>
            {% else %}
              <div class="action-buttons">
                <button class="btn-out-of-stock" disabled>
                  <i class="fa fa-times-circle"></i> Out of Stock
                </button>
                <button class="btn-favorite" id="btnFav">
                  <i class="fa fa-heart"></i>
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const btnPlus = document.getElementById("btnPlus");
  const btnMinus = document.getElementById("btnMinus");
  const txtQty = document.getElementById("txtQty");
  const pid = document.getElementById("pid");
  const btnCart = document.getElementById("btnCart");
  const btnFav = document.getElementById("btnFav");
  const maxQty = {{ products.quantity|default:0 }};

  const isAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};

  // Snackbar
  function showSnackbar(message) {
    const existing = document.getElementById('authSnackbar');
    if (existing) existing.remove();

    const snackbar = document.createElement('div');
    snackbar.id = 'authSnackbar';
    snackbar.innerHTML = `
      <i class="fas fa-exclamation-circle"></i>
      ${message}
      <a href="/login/" class="snackbar-btn">Login</a>
    `;
    document.body.appendChild(snackbar);
    setTimeout(() => snackbar.classList.add('show'), 100);
    setTimeout(() => {
      snackbar.classList.remove('show');
      setTimeout(() => snackbar.remove(), 300);
    }, 4000);
  }

  // Update cart count
  function updateCartCount() {
    fetch("/get_cart_count/", {
      method: 'GET',
      credentials: 'same-origin',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      const cartBadge = document.getElementById('cart-badge');
      if (cartBadge) {
        cartBadge.textContent = data.cart_count > 0 ? data.cart_count : '';
        cartBadge.style.display = data.cart_count > 0 ? 'inline' : 'none';
      }
      const favBadge = document.getElementById('fav-badge');
      if (favBadge) {
        favBadge.textContent = data.fav_count > 0 ? data.fav_count : '';
        favBadge.style.display = data.fav_count > 0 ? 'inline' : 'none';
      }
    })
    .catch(error => console.error('Error:', error));
  }

  // Notification
  function showNotification(message, type = 'success') {
    document.querySelectorAll('.custom-notification').forEach(n => n.remove());
    const n = document.createElement('div');
    n.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed custom-notification`;
    n.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    n.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 4000);
  }

  // Plus button
  if (btnPlus) {
    btnPlus.addEventListener("click", function() {
      let qty = parseInt(txtQty.value, 10) || 0;
      if (qty < maxQty) {
        txtQty.value = qty + 1;
      } else {
        showNotification('Maximum quantity reached!', 'error');
      }
    });
  }

  // Minus button
  if (btnMinus) {
    btnMinus.addEventListener("click", function() {
      let qty = parseInt(txtQty.value, 10) || 1;
      if (qty > 1) {
        txtQty.value = qty - 1;
      }
    });
  }

  // Add to Cart
  if (btnCart) {
    btnCart.addEventListener("click", function() {
      if (!isAuthenticated) {
        showSnackbar('Please login first to add items to cart!');
        return;
      }

      let qty = parseInt(txtQty.value, 10) || 0;
      if (qty > 0) {
        btnCart.disabled = true;
        btnCart.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Adding...';

        fetch("/addtocart", {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: JSON.stringify({ product_qty: qty, pid: pid.value })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status.includes('Added') || data.status.includes('updated')) {
            showNotification(data.status, 'success');
            updateCartCount();
          } else {
            showNotification(data.status, 'error');
          }
        })
        .catch(err => {
          showNotification('Error adding to cart.', 'error');
        })
        .finally(() => {
          btnCart.disabled = false;
          btnCart.innerHTML = '<i class="fa fa-shopping-cart"></i> Add to Cart';
        });
      }
    });
  }

  // Favorite button - ADD & REMOVE TOGGLE
  if (btnFav) {
    let isFavorite = false;

    btnFav.addEventListener("click", function() {
      if (!isAuthenticated) {
        showSnackbar('Please login first to add to favorites!');
        return;
      }

      btnFav.disabled = true;
      btnFav.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

      fetch("/fav", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ pid: pid.value })
      })
      .then(res => res.json())
      .then(data => {
        btnFav.innerHTML = '<i class="fa fa-heart"></i>';
        
        if (data.status.includes('Added')) {
          // Added to favorites
          isFavorite = true;
          btnFav.classList.add('active');
          showNotification('Added to favorites!', 'success');
        } else if (data.status.includes('Removed')) {
          // Removed from favorites
          isFavorite = false;
          btnFav.classList.remove('active');
          showNotification('Removed from favorites!', 'success');
        } else if (data.status.includes('already')) {
          // Already in favorites - remove it
          isFavorite = false;
          btnFav.classList.remove('active');
          showNotification(data.status, 'error');
        } else {
          showNotification(data.status, 'error');
        }
        
        updateCartCount();
      })
      .catch(err => {
        btnFav.innerHTML = '<i class="fa fa-heart"></i>';
        showNotification('Error updating favorites.', 'error');
      })
      .finally(() => {
        btnFav.disabled = false;
      });
    });
  }

  // Quantity validation
  if (txtQty) {
    txtQty.addEventListener('input', function() {
      let qty = parseInt(this.value, 10);
      if (isNaN(qty) || qty < 1) this.value = 1;
      else if (qty > maxQty) {
        this.value = maxQty;
        showNotification('Maximum quantity is ' + maxQty, 'error');
      }
    });
  }
});
</script>

{% endblock content %}